<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>线条小狗陪跑ToDo</title>
  <link rel="stylesheet" href="./base.css">
  <link rel="stylesheet" href="./my.css">
</head>

<body>
  <div class="todo">
    <div class="top">Todo-List</div>
    <div class="new">
      <input type="text" class="new-text" placeholder="新增待办事项">
      <button type="button" class="new-sub">提交</button>
    </div>
    <div class="list">
      <ul>
        <li class="first"><label>
            <input type="checkbox" class="task-checkbox" id="check-all">
            <span class="task-text">一键完成</span>
          </label>
        </li>
      </ul>
    </div>
  </div>
  <div class="recycle-bin">
    <h3>回收站</h3>
    <ul class="recycle-list"></ul>
  </div>
  <script>

    document.addEventListener('DOMContentLoaded', () => {
      loadFromStorage();
    });

    //全选框
    function checkedAll() {
      const ckall = document.querySelector('#check-all');
      const cks = document.querySelectorAll('.list input[type="checkbox"]:not(#check-all)');

      // 移除之前绑定的事件监听器
      ckall.replaceWith(ckall.cloneNode(true));
      cks.forEach((checkbox) => checkbox.replaceWith(checkbox.cloneNode(true)));

      const newCkall = document.querySelector('#check-all');
      const newCks = document.querySelectorAll('.list input[type="checkbox"]:not(#check-all)');

      // 全选框点击事件
      newCkall.addEventListener('click', function () {
        if (newCkall.checked) {
          const confirmResult = confirm('是否确定将所有事件标记为已完成？');
          if (confirmResult) {
            newCks.forEach((checkbox) => (checkbox.checked = true));
          } else {
            newCkall.checked = false;
          }
        } else {
          newCks.forEach((checkbox) => (checkbox.checked = false));
        }
      });

      // 子复选框点击事件
      newCks.forEach((checkbox) => {
        checkbox.addEventListener('click', function () {
          newCkall.checked = Array.from(newCks).every((cb) => cb.checked);
        });
      });
    }

    // 添加待办事项的函数
    function addNewTask(taskContent) {
      if (taskContent.trim() === '') {
        alert('待办事项内容不能为空！');
        newTextInput.value = '';
        return;
      }

      const currentTime = new Date();
      const formattedTime = currentTime.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      });

      // 创建新的 <li> 元素
      const newLi = document.createElement('li');
      newLi.innerHTML = `
      <input type="checkbox" class="task-checkbox check">
      <span class="task-text">${taskContent}</span>
       <span class="task-time">（创建时间：${formattedTime}）</span>
      <button type="button" class="delete-btn">删除</button>
    `;

      // 将新任务添加到列表中
      const secondLi = list.children[1];
      if (secondLi) {
        list.insertBefore(newLi, secondLi);
      } else {
        list.appendChild(newLi);
      }

      // 为新创建的删除按钮绑定事件
      const deleteButton = newLi.querySelector('.delete-btn')
      deleteButton.addEventListener('click', (event) => {
        const li = event.target.closest('li')
        li.remove()
        moveToRecycleBin(li)
      })

      enableEditTaskText(newLi)

      saveInStorage()

      // 清空输入框
      newTextInput.value = '';


      checkedAll()
    }

    //重写功能
    function enableEditTaskText(taskLi) {
      const taskText = taskLi.querySelector('.task-text');

      // 双击事件：将文字切换为输入框
      taskText.addEventListener('dblclick', () => {
        const originalText = taskText.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = originalText;
        input.className = 'edit-input';

        taskText.replaceWith(input);
        input.focus();

        // 保存修改
        const saveChanges = () => {
          const newText = input.value.trim();
          if (newText === '') {
            alert('待办事项内容不能为空！');
            input.value = originalText;
          } else {

            const newTaskText = document.createElement('span');
            newTaskText.className = 'task-text';
            newTaskText.textContent = newText;

            input.replaceWith(newTaskText);
            enableEditTaskText(taskLi);
          }
        };

        input.addEventListener('blur', saveChanges);
        input.addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            saveChanges();
          }
        })
      })
      saveInStorage()
    }

    const newTextInput = document.querySelector('.new-text');
    const newSubmitButton = document.querySelector('.new-sub');
    const list = document.querySelector('.list ul');
    const recycleList = document.querySelector('.recycle-list');



    // 将任务移动到回收站
    function moveToRecycleBin(taskLi) {
      taskLi.querySelector('.delete-btn').remove();
      taskLi.querySelector('.task-checkbox').remove();

      const restoreButton = document.createElement('button');
      restoreButton.textContent = '恢复';
      restoreButton.className = 'restore-btn';
      taskLi.appendChild(restoreButton);

      const deleteForeverButton = document.createElement('button');
      deleteForeverButton.textContent = '彻底删除';
      deleteForeverButton.className = 'delete-forever-btn';
      taskLi.appendChild(deleteForeverButton);

      recycleList.appendChild(taskLi);

      restoreButton.addEventListener('click', () => restoreTask(taskLi));

      // 彻底删除按钮事件
      deleteForeverButton.addEventListener('click', () => {
        const answer = confirm('是否确认彻底删除该记录？');
        if (answer) {
          taskLi.remove();
          saveInStorage();
        }
      });

      saveInStorage()
      checkedAll()
    }


    //恢复到todo-list
    function restoreTask(taskLi) {
      const restoreButton = taskLi.querySelector('.restore-btn');
      if (restoreButton) {
        restoreButton.remove(); // 移除恢复按钮
      }
      const deleteForeverButton = taskLi.querySelector('.delete-forever-btn');
      if (deleteForeverButton) {
        deleteForeverButton.remove(); // 移除彻底删除按钮
      }

      const deleteButton = document.createElement('button');
      deleteButton.textContent = '删除';
      deleteButton.className = 'delete-btn';
      taskLi.appendChild(deleteButton);

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'task-checkbox check';
      checkbox.checked = true
      taskLi.insertBefore(checkbox, taskLi.firstChild);

      list.appendChild(taskLi);

      deleteButton.addEventListener('click', () => moveToRecycleBin(taskLi));

      saveInStorage()
      checkedAll()
    }

    newSubmitButton.addEventListener('click', () => {
      const taskContent = newTextInput.value;
      addNewTask(taskContent);
    });

    newTextInput.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        const taskContent = newTextInput.value;
        addNewTask(taskContent);
      }

      checkedAll()
      saveInStorage()

    });



    //标题效果
    (function () {
      const top = document.querySelector('.top')
      const animate = () => {
        top.style.transition = 'all 2.5s'
        top.style.transform = 'scale(1.04)'
        top.style.backgroundColor = 'rgba(241, 249, 255, 0.1)'
        top.style.color = 'rgb(158, 226, 233)'
        setTimeout(() => {
          top.style.transform = 'scale(1)'
          top.style.backgroundColor = 'rgba(241, 249, 255, 0.4)'
        }, 2000)
      }
      let interval = setInterval(animate, 4000)
    })();



    //保存至仓库
    function saveInStorage() {
      const arrTodo = [];
      const arrFinished = [];

      // 保存主列表内容
      list.querySelectorAll('li:not(.first)').forEach((li) => {
        const taskTextElement = li.querySelector('.task-text');
        const taskTimeElement = li.querySelector('.task-time');

        if (taskTextElement && taskTimeElement) {
          const taskText = taskTextElement.textContent;
          const taskTime = taskTimeElement.textContent;
          arrTodo.push({ text: taskText, time: taskTime });
        }
      });

      // 保存回收站内容
      recycleList.querySelectorAll('li').forEach((li) => {
        const taskTextElement = li.querySelector('.task-text');
        const taskTimeElement = li.querySelector('.task-time');

        if (taskTextElement && taskTimeElement) {
          const taskText = taskTextElement.textContent;
          const taskTime = taskTimeElement.textContent;
          arrFinished.push({ text: taskText, time: taskTime });
        }
      });

      // 保存到 localStorage
      localStorage.setItem('arrTodo', JSON.stringify(arrTodo));
      localStorage.setItem('arrFinished', JSON.stringify(arrFinished));
      checkedAll()
    }


    //取出数据
    function loadFromStorage() {
      const arrTodo = JSON.parse(localStorage.getItem('arrTodo')) || []
      const arrFinished = JSON.parse(localStorage.getItem('arrFinished')) || []

      arrTodo.forEach((task) => {
        const newLi = document.createElement('li');
        newLi.innerHTML = `
      <input type="checkbox" class="task-checkbox check">
      <span class="task-text">${task.text}</span>
      <span class="task-time">${task.time}</span>
      <button type="button" class="delete-btn">删除</button>`

        list.appendChild(newLi);

        const deleteButton = newLi.querySelector('.delete-btn')
        deleteButton.addEventListener('click', () => moveToRecycleBin(newLi));

        enableEditTaskText(newLi)
      })

      arrFinished.forEach((task) => {
        const newLi = document.createElement('li');
        newLi.innerHTML = `
      <span class="task-text">${task.text}</span>
      <span class="task-time">${task.time}</span>
      <button type="button" class="restore-btn">恢复</button>
      <button type="button" class="delete-forever-btn">彻底删除</button>`

        recycleList.appendChild(newLi)

        const restoreButton = newLi.querySelector('.restore-btn')
        const deleteForeverButton = newLi.querySelector('.delete-forever-btn')

        restoreButton.addEventListener('click', () => restoreTask(newLi))
        deleteForeverButton.addEventListener('click', () => {
          const answer = confirm('是否确认彻底删除该记录？')
          if (answer) {
            newLi.remove()
            saveInStorage()
          }
        })
      })

      saveInStorage()
      checkedAll()
    }

  </script>
</body>

</html>